2022.08.21 TIL

## TCP 3 way handshake & 4 way handshake

### TCP 3 way handshake

> TCP/IP ν”„λ΅ν† μ½μ„ μ΄μ©ν•΄μ„ ν†µμ‹ μ„ ν•λ” ν”„λ΅κ·Έλ¨ μ‚¬μ΄μ—μ„, λ°μ΄ν„°λ¥Ό μ „μ†΅ν•κΈ° μ „μ— λ„¤νΈμ›ν¬ μ—°κ²°μ„ μ„¤μ •ν•λ” κ³Όμ •. 

![](https://t1.daumcdn.net/cfile/tistory/225A964D52F1BB6917)

3 way handshakeλ” λ‹¤μ μ„Έ λ‹¨κ³„λ΅ μ§„ν–‰λλ‹¤.

- [STEP 1]
    - ν΄λΌμ΄μ–ΈνΈκ°€ μ„λ²„λ΅ μ ‘μ†μ„ μ”μ²­ν•λ” SYNμ„ λ³΄λ‚Έλ‹¤. 
    - ν΄λΌμ΄μ–ΈνΈλ” μ‘λ‹µμ΄ μ¬ λ•κΉμ§€ SYN_SENT μƒνƒκ°€ λλ‹¤.
- [STEP 2]
    - μ„λ²„λ” μ ‘μ†μ„ μ›ν•λ” ν΄λΌμ΄μ–ΈνΈλ΅λ¶€ν„° SYNλ¥Ό μμ‹ ν•κ³  μ”μ²­μ„ μλ½ν•λ‹¤λ” SYN+ACKλ¥Ό μ‘λ‹µμΌλ΅ μ „μ†΅ν•λ‹¤. 
    - μ΄λ• μ„λ²„λ” SYN_RECEIVED μƒνƒκ°€ λλ‹¤.
- [STEP 3]
    - ν΄λΌμ΄μ–ΈνΈλ” μ„λ²„μ—κ² ACKλ¥Ό λ³΄λ‚΄κ³  ESTABLISHED μƒνƒκ°€ λμ–΄ μ—°κ²°μ΄ μ΄λ£¨μ–΄μ§„λ‹¤.

μ΄λ¬ν• μ μ°¨κ°€ ν•„μ”ν• μ΄μ 
- μ‹ λΆ°μ„± μλ” μ—°κ²°μ„ μƒμ„±ν•κΈ° μ„ν•¨
- μ–‘μ½ λ¨λ‘ λ°μ΄ν„°λ¥Ό μ „μ†΅ν•  μ¤€λΉ„κ°€ λμ—λ‹¤λ” κ²ƒμ„ λ³΄μ¥ν•κΈ° μ„ν•¨



### TCP 4 way handshake
> TCP 4 way handshakeλ” λ°λ€λ΅ ν΄λΌμ΄μ–ΈνΈκ°€ λ„¤νΈμ›ν¬ μ—°κ²°μ„ μΆ…λ£ν•λ” κ³Όμ •.

![](https://t1.daumcdn.net/cfile/tistory/2152353F52F1C02835)

4 way handshakeλ” λ‹¤μ λ„¤ λ‹¨κ³„λ΅ μ§„ν–‰λλ‹¤.

- [STEP 1]
    - ν΄λΌμ΄μ–ΈνΈκ°€ μ—°κ²°μ„ μΆ…λ£ν•κ² λ‹¤λ” FINμ„ μ „μ†΅ν•λ‹¤.
- [STEP 2]
    - μ„λ²„λ” FINμ„ μμ‹ ν•κ³  ν™•μΈν–λ‹¤λ” ACKλ¥Ό μ „μ†΅ν•λ‹¤. 
    - ACKλ¥Ό μμ‹ ν• ν΄λΌμ΄μ–ΈνΈλ” FIN_WAIT μƒνƒκ°€ λκ³  μ„λ²„λ” CLOSE_WAIT μƒνƒκ°€ λλ‹¤.
- [STEP 3]
    - μ„λ²„κ°€ λ‚¨μ•„μλ” μ‘μ—…μ„ λ§λ¬΄λ¦¬ν•κ³  μΆ…λ£ κ°€λ¥ν• μƒνƒκ°€ λλ©΄ ν΄λΌμ΄μ–ΈνΈλ΅ μ—°κ²°μ΄ μΆ…λ£λμ—λ‹¤κ³  FINμ„ μ „μ†΅ν•λ‹¤.
- [STEP 4]
    - ν΄λΌμ΄μ–ΈνΈλ” FINμ„ ν™•μΈν–λ‹¤λ” μ‹ νΈμΈ ACKλ¥Ό λ³΄λ‚΄κ³  μ μ‹ TIME_WAIT κ°€ λ ν›„ CLOSED μƒνƒκ°€ λλ‹¤.

μ΄λ¬ν• μ μ°¨κ°€ ν•„μ”ν• μ΄μ 
- λ„¤νΈμ›ν¬ μ—°κ²°μ„ μΆ…λ£ν•κ² λ‹¤λ” ν™•μ‹¤ν• λ©”μ‹μ§€κ°€ μ—†μΌλ©΄ μ„λ²„μ™€ ν΄λΌμ΄μ–ΈνΈλ” μƒλ€λ°©μ΄ μ–Έμ  λ°μ΄ν„°λ¥Ό λ³΄λ‚Όμ§€ λ¨λ¥΄κΈ° λ•λ¬Έμ— κ³„μ† λ€κΈ°ν•λ” μƒνƒκ°€ λ  κ²ƒμ„.
- λ” μ΄μƒ λ°μ΄ν„°λ¥Ό λ³΄λ‚΄μ§€ μ•μμ„ ν™•μ‹¤ν ν™•μΈν•μ—¬ λ°μ΄ν„° μ μ‹¤μ„ λ§‰κΈ° μ„ν•¨.


### μ¶”κ°€ λ‚΄μ©: TIME_WAIT
μ„λ²„μ—μ„ λ³΄λ‚Έ λ°μ΄ν„°κ°€ μ§€μ—°μΌλ΅ μΈν•΄ FINλ³΄λ‹¤ λ¦κ² λ„μ°©ν•λ‹¤λ©΄ (μλ¥Ό λ“¤λ©΄ ν¨ν‚· μ μ‹¤λ΅ μΈν• μ¬μ „μ†΅)
ν΄λΌμ΄μ–ΈνΈμ—μ„ μ„Έμ…μ„ μΆ…λ£ν–κΈ° λ•λ¬Έμ— μ΄ ν¨ν‚·μ€ Dropλμ–΄ λ°μ΄ν„° μ μ‹¤ λ°μƒ.
μ΄λ¬ν• ν„μƒμ— λ€λΉ„ν•κΈ° μ„ν•΄ Clientλ” FINμ„ μμ‹ ν•λ”λΌλ„ μΌμ •μ‹κ°„(default 240 seconds) λ™μ• μ„Έμ…μ„ λ‚¨κ²¨λ†“κ³  μ‰μ—¬ ν¨ν‚·μ„ κΈ°λ‹¤λ¦¬λ” κ³Όμ •μ„ κ±°μΉκ² λλ‹¤.

μ¶μ²
[λ„¤νΈμ›ν¬ μ‰½κ² μ΄ν•΄ν•κΈ° 22νΈ. TCP 3 Way-Handshake & 4 Way-Handshake](https://mindnet.tistory.com/entry/λ„¤νΈμ›ν¬-μ‰½κ²-μ΄ν•΄ν•κΈ°-22νΈ-TCP-3-WayHandshake-4-WayHandshake)

___


## TCP 3 way handshake & 4 way handshake

### TCP 3 way handshake
 ![](https://t1.daumcdn.net/cfile/tistory/225A964D52F1BB6917)

- TCP/IP ν”„λ΅ν† μ½μ„ μ΄μ©ν•΄μ„ ν†µμ‹ μ„ ν•λ” ν”„λ΅κ·Έλ¨ μ‚¬μ΄μ—μ„, λ°μ΄ν„°λ¥Ό μ „μ†΅ν•κΈ° μ „μ— λ„¤νΈμ›ν¬ μ—°κ²°μ„ μ„¤μ •ν•λ” κ³Όμ •μ…λ‹λ‹¤. 

λ¨Όμ € ν΄λΌμ΄μ–ΈνΈκ°€ μ„λ²„λ΅ μ ‘μ†μ„ μ”μ²­ν•λ” SYNμ„ λ³΄λƒ…λ‹λ‹¤. ν΄λΌμ΄μ–ΈνΈλ” μ‘λ‹µμ΄ μ¬ λ•κΉμ§€ SYN_SENT μƒνƒκ°€ λ©λ‹λ‹¤.
μ„λ²„λ” μ ‘μ†μ„ μ›ν•λ” ν΄λΌμ΄μ–ΈνΈλ΅λ¶€ν„° SYNλ¥Ό μμ‹ ν•κ³  μ”μ²­μ„ μλ½ν•λ‹¤λ” SYN+ACKλ¥Ό μ‘λ‹µμΌλ΅ μ „μ†΅ν•©λ‹λ‹¤. μ΄λ• μ„λ²„λ” SYN_RECEIVED μƒνƒκ°€ λ©λ‹λ‹¤.
ν΄λΌμ΄μ–ΈνΈλ” μ„λ²„μ—κ² ACKλ¥Ό λ³΄λ‚΄κ³  ESTABLISHED μƒνƒκ°€ λμ–΄ μ—°κ²°μ΄ μ΄λ£¨μ–΄μ§‘λ‹λ‹¤.
μ΄λ¬ν• μ μ°¨κ°€ ν•„μ”ν• μ΄μ λ” μ–‘μ½ λ¨λ‘ λ°μ΄ν„°λ¥Ό μ „μ†΅ν•  μ¤€λΉ„κ°€ λμ—λ‹¤λ” κ²ƒμ„ λ³΄μ¥ν•κΈ° μ„ν•¨μ…λ‹λ‹¤.

> κ°κ° μ„λ²„μ™€ ν΄λΌμ΄μ–ΈνΈμ μƒνƒλ… κΉμ§€λ” μ¤‘μ”ν•μ§€ μ•μ€ κ²ƒ κ°™κ³  SYNκ³Ό ACKν”λκ·Έλ¥Ό λ³΄λ‚Έλ‹¤λ” κ²ƒ, κ°„λµν• handshake ν†µμ‹  λ‹¨κ³„μ™€ κ·Έ μ΄μ μ— λ€ν•΄μ„λ§ μ§§κ² λ‹µν•λ” κ²ƒλ„ μΆ‹μ•„λ³΄μ…λ‹λ‹¤.

### TCP 4 way handshake
![](https://t1.daumcdn.net/cfile/tistory/2152353F52F1C02835)
π“ μ¤ν¬λ¦½νΈ
- λ‹¤μμΌλ΅ TCP 4 way handshakeμ— λ€ν•΄ λ§μ”€λ“λ¦¬κ² μµλ‹λ‹¤.
TCP 4 way handshakeλ” λ°λ€λ΅ ν΄λΌμ΄μ–ΈνΈκ°€ λ„¤νΈμ›ν¬ μ—°κ²°μ„ μΆ…λ£ν•λ” κ³Όμ •μ…λ‹λ‹¤. 
4 way handshakeλ” λ‹¤μ λ„¤ λ‹¨κ³„λ΅ μ§„ν–‰λ©λ‹λ‹¤.
ν΄λΌμ΄μ–ΈνΈκ°€ μ—°κ²°μ„ μΆ…λ£ν•κ² λ‹¤λ” FINμ„ μ „μ†΅ν•©λ‹λ‹¤.
μ„λ²„λ” FINμ„ μμ‹ ν•κ³  ν™•μΈν–λ‹¤λ” ACKλ¥Ό μ „μ†΅ν•©λ‹λ‹¤. ACKλ¥Ό μμ‹ ν• ν΄λΌμ΄μ–ΈνΈλ” FIN_WAIT μƒνƒκ°€ λκ³  μ„λ²„λ” CLOSE_WAIT μƒνƒκ°€ λ©λ‹λ‹¤.
μ„λ²„κ°€ λ‚¨μ•„μλ” μ‘μ—…μ„ λ§λ¬΄λ¦¬ν•κ³  μΆ…λ£ κ°€λ¥ν• μƒνƒκ°€ λλ©΄ ν΄λΌμ΄μ–ΈνΈλ΅ μ—°κ²°μ΄ μΆ…λ£λμ—λ‹¤κ³  FINμ„ μ „μ†΅ν•©λ‹λ‹¤.
ν΄λΌμ΄μ–ΈνΈλ” FINμ„ ν™•μΈν–λ‹¤λ” μ‹ νΈμΈ ACKλ¥Ό λ³΄λ‚΄κ³  CLOSED μƒνƒκ°€ λ©λ‹λ‹¤.
μ—°κ²° μΆ…λ£μ— μ΄λ° κ³Όμ •μ΄ ν•„μ”ν• μ΄μ λ” μ†΅μμ‹  κ³Όμ •μ—μ„ λ” μ΄μƒ λ°μ΄ν„°λ¥Ό λ³΄λ‚΄μ§€ μ•μμ„ ν™•μ‹¤ν ν™•μΈν•μ—¬ λ°μ΄ν„° μ μ‹¤μ„ λ§‰κΈ° μ„ν•΄μ„μ…λ‹λ‹¤.

> λ§μ°¬κ°€μ§€λ΅ handshakeμ μ μ°¨λ§ μ§κ³  λ„μ–΄κ°€λ„ κ΄μ°®μΌλ‚ CLOSE_WAIT, TIME_WAIT λ“± κ° μƒνƒμ— λ€ν•΄μ„λ” μ–΄λ–»κ² λ‹¤λ¥Έμ§€ λ°”λ΅ λ€λ‹µν•  μ μμ–΄μ•Ό ν•  κ²ƒ κ°™μµλ‹λ‹¤.

## μμƒ κΌ¬λ¦¬ μ§λ¬Έ
### μ¶”κ°€ λ‚΄μ©1: TIME_WAIT μƒνƒκ°€ μλ―Έν•λ” κ²ƒμ€?
- μ„λ²„μ—μ„ λ³΄λ‚Έ λ°μ΄ν„°κ°€ μ§€μ—°μΌλ΅ μΈν•΄ FINλ³΄λ‹¤ λ¦κ² λ„μ°©ν•λ‹¤λ©΄ (μλ¥Ό λ“¤λ©΄ ν¨ν‚· μ μ‹¤λ΅ μΈν• μ¬μ „μ†΅)
ν΄λΌμ΄μ–ΈνΈμ—μ„ μ„Έμ…μ„ μΆ…λ£ν–κΈ° λ•λ¬Έμ— μ΄ ν¨ν‚·μ€ Dropλμ–΄ λ°μ΄ν„° μ μ‹¤ λ°μƒ.
μ΄λ¬ν• ν„μƒμ— λ€λΉ„ν•κΈ° μ„ν•΄ Clientλ” FINμ„ μμ‹ ν•λ”λΌλ„ μΌμ •μ‹κ°„(default 240 seconds) λ™μ• μ„Έμ…μ„ λ‚¨κ²¨λ†“κ³  μ‰μ—¬ ν¨ν‚·μ„ κΈ°λ‹¤λ¦¬λ” κ³Όμ •μ„ κ±°μΉκ² λλ‹¤.

### μ¶”κ°€ λ‚΄μ©2: 4 way handshakeμ—μ„ λ§μ§€λ§‰ ackκ°€ ν•„μ”ν• μ΄μ λ”?
- FINμ„ λ³΄λ‚Όλ•μ μλ―Έλ” λ”μ΄μƒ λ³΄λ‚Ό λ°μ΄ν„°κ°€ μ—†μμ„ μ•λ ¤μ£ΌκΈ° μ„ν•¨μ΄λ‹¤. λ§μ•½ FINμ΄ μ μ‹¤λλ‹¤λ©΄ μμ‹  μΈ΅μ—μ„λ” μ•„μ§ λ³΄λ‚Ό λ°μ΄ν„°κ°€ μλ‹¤κ³  μΈμ‹ν•κ² λκ³  λ”°λΌμ„ κ³„μ† λ€κΈ°ν•κ² λλ‹¤. κ·Έλ ‡κ² λ•λ¬Έμ— FINμ„ λ³΄λ‚Έ μ…μ¥μ—μ„λ” μƒλ€λ°©μ΄ FINμ„ ν™•μ‹¤ν λ°›μ•λ”μ§€λ¥Ό μ•μ•„μ•Ό ν•λ‹¤. κ·Έλ ‡κ² ν•κΈ° μ„ν•΄μ„, λ§μ§€λ§‰ ACKλ¥Ό μ‘λ‹µμΌλ΅ λ³΄λ‚΄μ•Όλ§ ν•λ‹¤.


## μ¶μ²
[λ„¤νΈμ›ν¬ μ‰½κ² μ΄ν•΄ν•κΈ° 22νΈ. TCP 3 Way-Handshake & 4 Way-Handshake](https://mindnet.tistory.com/entry/λ„¤νΈμ›ν¬-μ‰½κ²-μ΄ν•΄ν•κΈ°-22νΈ-TCP-3-WayHandshake-4-WayHandshake)
[4-way-handshakeμ—μ„ λ§μ§€λ§‰ ackκ°€ ν•„μ”ν• μ΄μ ](https://jaegukim.github.io/posts/4wayHandshakeLastAckLost/)